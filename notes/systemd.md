# systemd

[ref](https://www.youtube.com/watch?v=Kzpm-rGAXos)

- init system → first process when you boot up linux. PID 1.
- it manages all services that run in the background.
- `htop` more interactive than `top`, you can sort my clicking.

| systemd is the init system on Linux — it starts the system and manages background services. You interact with it using systemctl to start, stop, or inspect services.
journalctl lets you view logs and events generated by those services and the system itself.

## Working with Units

- Resources that it's able to manage. These include services, mounts, automounts, etc.
- A service is a type of unit.

Ran `sudo apt install apache2` to install apache web server.

``` bash
shad@linux:~$ systemctl status apache2
● apache2.service - The Apache HTTP Server
     Loaded: loaded (/usr/lib/systemd/system/apache2.service; enabled; preset: enabl>
     Active: active (running) since Sun 2025-10-26 16:54:34 UTC; 2min 27s ago
       Docs: https://httpd.apache.org/docs/2.4/
   Main PID: 4435 (apache2)
      Tasks: 55 (limit: 9447)
     Memory: 5.3M (peak: 5.7M)
        CPU: 44ms
     CGroup: /system.slice/apache2.service
             ├─4435 /usr/sbin/apache2 -k start
             ├─4438 /usr/sbin/apache2 -k start
             └─4439 /usr/sbin/apache2 -k start

Oct 26 16:54:34 linux systemd[1]: Starting apache2.service - The Apache HTTP Server.>
Oct 26 16:54:34 linux systemd[1]: Started apache2.service - The Apache HTTP Server.

# Looks like it's running! We can now run:

shad@linux:~$ curl localhost | head
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <!--
 10671  100 10671    0     0  7507k      0 --:--:-- --:--:-- --:--:-- 10.1M
    Modified from the Debian original for Ubuntu
    Last updated: 2022-03-22
    See: https://launchpad.net/bugs/1966004
  -->
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Apache2 Ubuntu Default Page: It works</title>

# and we see that the systemd service named apache2 is indeed running!

# So it looks like apache2 will start automatically on boot. We can verify this with:
shad@linux:~$ systemctl is-enabled apache2
enabled

# I personally don't want to have it start on boot, so I'll stop the service and disable it:
shad@linux:~$ sudo systemctl stop apache2
shad@linux:~$ curl localhost | head -n 5
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
curl: (7) Failed to connect to localhost port 80 after 0 ms: Couldnt connect to server

shad@linux:~$ sudo systemctl disable apache2
Synchronizing state of apache2.service with SysV service script with /usr/lib/systemd/systemd-sysv-install.
Executing: /usr/lib/systemd/systemd-sysv-install disable apache2
Removed "/etc/systemd/system/multi-user.target.wants/apache2.service".
shad@linux:~$ systemctl is-enabled apache2
disabled

# Now we see that it has stopped.
shad@linux:~$ sudo systemctl status apache2
○ apache2.service - The Apache HTTP Server
     Loaded: loaded (/usr/lib/systemd/system/apache2.service; disabled; preset: enab>
     Active: inactive (dead) since Sun 2025-10-26 17:19:19 UTC; 13s ago
   Duration: 7.201s
       Docs: https://httpd.apache.org/docs/2.4/
    Process: 6080 ExecStart=/usr/sbin/apachectl start (code=exited, status=0/SUCCESS)
    Process: 6159 ExecStop=/usr/sbin/apachectl graceful-stop (code=exited, status=0/>
   Main PID: 6083 (code=exited, status=0/SUCCESS)
        CPU: 48ms

Oct 26 17:19:11 linux systemd[1]: Starting apache2.service - The Apache HTTP Server.>
Oct 26 17:19:12 linux systemd[1]: Started apache2.service - The Apache HTTP Server.
Oct 26 17:19:19 linux systemd[1]: Stopping apache2.service - The Apache HTTP Server.>
Oct 26 17:19:19 linux systemd[1]: apache2.service: Deactivated successfully.
Oct 26 17:19:19 linux systemd[1]: Stopped apache2.service - The Apache HTTP Server.

```

- so `sudo systemctl enable/dispable <service>` to enable/disable on boot.

## Where are Systemd's Unit files stored?

- A unit file is anything that systemd can manage.
- systemd is looking at unit files to understand how to interact with processes.
- service files are just text files that contain instructions that tell systemd how to manage that particular service.
- 

When you run `systemctl status apache2`, the line `Loaded: loaded (/usr/lib/systemd/system/apache2.service;` tells you where the unit file is located, rather than you needing to run `find` command.

In any scenario where you want to override or extend the service, don't edit the base unit file. Instead, do `sudo systemctl edit apache2`, which creates an override file at `/etc/systemd/system/apache2.service.d/override.conf`. This works because the override file has a higher priority than the base unit file (see below).

Systemd unit directories (in order of priority):
1. `/etc/systemd/system/` - 
2. `/run/systemd/system/` - Stores runtime systemd units.
3. `/usr/lib/systemd/system/`

So upon boot, systemd starts, then systemd will go into these directories looking for unit files. If it finds any, it will load those into memory.

To see the merged result, do `systemctl cat apache2`.

## Undestanding what's in a Unit File

`shad@linux:~$ cat /usr/lib/systemd/system/apache2.service `

``` ini
[Unit]
Description=The Apache HTTP Server

# network.target means that we want the network to be up before starting apache.
After=network.target remote-fs.target nss-lookup.target
Documentation=https://httpd.apache.org/docs/2.4/

[Service]
# forking means that the process is considered to be started when other processes are spwed from a parent process, and then that parent process stops to where the children are the only processes that are running.
# comes down to design decisions by the linux distro.
Type=forking
Environment=APACHE_STARTED_BY_SYSTEMD=true

# what happens when the process is started up?
ExecStart=/usr/sbin/apachectl start
ExecStop=/usr/sbin/apachectl graceful-stop

# reload will cause the process to reload its configuration files, which enables a setting to take effect w/o users getting disconnected.
# for apache, this is preffered as we'd rather not disconnect users from our website if we don't have to.
# not every service supports reload.
ExecReload=/usr/sbin/apachectl graceful
KillMode=mixed
PrivateTmp=true
Restart=on-abort
OOMPolicy=continue

[Install]
WantedBy=multi-user.target
```

## Altering Unit Files

`sudo systemctl edit apache2`

``` ini
## Editing /etc/systemd/system/apache2.service.d/override.conf
### Anything between here and the comment below will become the contents of the drop>

[Unit]
Description=Apache is awesome

### Edits below this comment will be discarded


### /usr/lib/systemd/system/apache2.service
# [Unit]
# Description=The Apache HTTP Server
```

`Successfully installed edited file '/etc/systemd/system/apache2.service.d/override.conf'.`
